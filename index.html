<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PiXiEEDraw</title>
    <meta name="theme-color" content="#1f1f1f" />
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="stylesheet" href="assets/css/style.css" />
  </head>
  <body>
    <div class="app" id="appRoot">
      <div class="layout" id="appLayout">
        <aside class="rail rail--left" id="leftRail" data-collapsed="false" aria-label="ツールとカラー設定">
          <div class="rail-tabs" id="leftRailTabs" role="tablist" aria-label="左パネル切替">
            <button type="button" class="rail-tab is-active" data-left-tab="tools" role="tab" aria-selected="true" aria-controls="panelTools">ツール</button>
            <button type="button" class="rail-tab" data-left-tab="color" role="tab" aria-selected="false" aria-controls="panelColor" tabindex="-1">カラー</button>
          </div>
          <div class="rail-tabpanes" id="leftRailPanes"></div>
        </aside>
        <main class="stage" id="stage" aria-label="ドットキャンバス">
          <div class="stage__canvas" id="canvasViewport">
            <div class="canvas-stack" id="canvasStack" aria-live="off">
              <canvas id="drawingCanvas" width="128" height="128" aria-label="描画キャンバス"></canvas>
              <canvas id="overlayCanvas" width="128" height="128" aria-hidden="true"></canvas>
              <canvas id="selectionCanvas" width="128" height="128" aria-hidden="true"></canvas>
            </div>
            <div class="canvas-controls">
              <button type="button" class="chip" id="undoAction" aria-label="元に戻す" disabled>↺</button>
              <button type="button" class="chip" id="redoAction" aria-label="やり直す" disabled>↻</button>
              <div class="zoom-control" role="group" aria-label="ズーム">
                <button type="button" class="chip" id="zoomOut">−</button>
                <span id="zoomLevel">100%</span>
                <button type="button" class="chip" id="zoomIn">＋</button>
              </div>
            </div>
            <button type="button" class="rail-toggle rail-toggle--left" id="openLeftRail" aria-label="左パネルを表示">⟨</button>
            <button type="button" class="rail-toggle rail-toggle--right" id="openRightRail" aria-label="右パネルを表示">⟩</button>
          </div>
        </main>
        <aside class="rail rail--right" id="rightRail" data-collapsed="false" aria-label="フレーム、レイヤー、設定">
          <div class="rail-tabs" id="rightRailTabs" role="tablist" aria-label="右パネル切り替え">
            <button type="button" class="rail-tab is-active" data-right-tab="frames" role="tab" aria-selected="true" aria-controls="panelFrames">レイヤー</button>
            <button type="button" class="rail-tab" data-right-tab="settings" role="tab" aria-selected="false" aria-controls="panelSettings" tabindex="-1">設定</button>
          </div>
          <div class="rail-tabpanes" id="rightRailPanes"></div>
        </aside>
      </div>

      <div class="mobile-drawer" id="mobileDrawer" hidden>
        <div class="mobile-tabs" role="tablist" aria-label="モバイル操作パネル">
          <button type="button" class="mobile-tab is-active" id="mobileTabTools" data-mobile-tab="tools" role="tab" aria-controls="mobilePanelTools" aria-selected="true">ツール</button>
          <button type="button" class="mobile-tab" id="mobileTabColor" data-mobile-tab="color" role="tab" aria-controls="mobilePanelColor" aria-selected="false" tabindex="-1">カラー</button>
          <button type="button" class="mobile-tab" id="mobileTabFrames" data-mobile-tab="frames" role="tab" aria-controls="mobilePanelFrames" aria-selected="false" tabindex="-1">フレーム/レイヤー</button>
          <button type="button" class="mobile-tab" id="mobileTabSettings" data-mobile-tab="settings" role="tab" aria-controls="mobilePanelSettings" aria-selected="false" tabindex="-1">設定</button>
        </div>
        <div class="mobile-panels" id="mobilePanels">
          <div class="mobile-panel is-active" id="mobilePanelTools" role="tabpanel" aria-labelledby="mobileTabTools"></div>
          <div class="mobile-panel" id="mobilePanelColor" role="tabpanel" aria-labelledby="mobileTabColor" hidden></div>
          <div class="mobile-panel" id="mobilePanelFrames" role="tabpanel" aria-labelledby="mobileTabFrames" hidden></div>
          <div class="mobile-panel" id="mobilePanelSettings" role="tabpanel" aria-labelledby="mobileTabSettings" hidden></div>
        </div>
      </div>

      <section class="panel-section" id="panelTools" data-section="tools">
        <div class="panel-section__body">
          <div class="tool-group-tabs" role="tablist" aria-label="ツールカテゴリ">
            <button type="button" class="tool-group-button is-active" data-tool-group="selection" role="tab" aria-selected="true">範囲選択</button>
            <button type="button" class="tool-group-button" data-tool-group="pen" role="tab" aria-selected="false">ペン</button>
            <button type="button" class="tool-group-button" data-tool-group="eraser" role="tab" aria-selected="false">消しゴム</button>
            <button type="button" class="tool-group-button" data-tool-group="shape" role="tab" aria-selected="false">図形</button>
            <button type="button" class="tool-group-button" data-tool-group="fill" role="tab" aria-selected="false">塗りつぶし</button>
          </div>
          <div class="tool-grid" id="toolGrid" role="toolbar" aria-label="描画ツール">
            <button type="button" class="tool-button is-active" data-tool="pen" data-tool-group="pen" aria-pressed="true">
              <img src="assets/icons/tool-pen-new.svg" alt="ペン" width="32" height="32" />
              <span>ペン</span>
            </button>
            <button type="button" class="tool-button" data-tool="eyedropper" data-tool-group="pen" aria-pressed="false">
              <img src="assets/icons/tool-eyedropper.png" alt="スポイト" width="32" height="32" />
              <span>スポイト</span>
            </button>
            <button type="button" class="tool-button" data-tool="eraser" data-tool-group="eraser" aria-pressed="false">
              <img src="assets/icons/tool-eraser.png" alt="消しゴム" width="32" height="32" />
              <span>消しゴム</span>
            </button>
            <button type="button" class="tool-button" data-tool="line" data-tool-group="shape" aria-pressed="false">
              <svg class="tool-icon" viewBox="0 0 32 32" width="32" height="32" aria-hidden="true" focusable="false"><line x1="4" y1="28" x2="28" y2="4" stroke="currentColor" stroke-width="4" stroke-linecap="round" /></svg>
              <span>直線</span>
            </button>
            <button type="button" class="tool-button" data-tool="curve" data-tool-group="shape" aria-pressed="false">
              <svg class="tool-icon" viewBox="0 0 32 32" width="32" height="32" aria-hidden="true" focusable="false"><path d="M4 24c6-10 10-16 24-16" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" /></svg>
              <span>曲線</span>
            </button>
            <button type="button" class="tool-button" data-tool="rect" data-tool-group="shape" aria-pressed="false">
              <svg class="tool-icon" viewBox="0 0 32 32" width="32" height="32" aria-hidden="true" focusable="false"><rect x="6" y="6" width="20" height="20" fill="none" stroke="currentColor" stroke-width="4" rx="2" /></svg>
              <span>四角</span>
            </button>
            <button type="button" class="tool-button" data-tool="rectFill" data-tool-group="shape" aria-pressed="false">
              <svg class="tool-icon" viewBox="0 0 32 32" width="32" height="32" aria-hidden="true" focusable="false"><rect x="6" y="6" width="20" height="20" fill="currentColor" rx="2" /></svg>
              <span>塗り四角</span>
            </button>
            <button type="button" class="tool-button" data-tool="ellipse" data-tool-group="shape" aria-pressed="false">
              <svg class="tool-icon" viewBox="0 0 32 32" width="32" height="32" aria-hidden="true" focusable="false"><circle cx="16" cy="16" r="10" fill="none" stroke="currentColor" stroke-width="4" /></svg>
              <span>丸</span>
            </button>
            <button type="button" class="tool-button" data-tool="ellipseFill" data-tool-group="shape" aria-pressed="false">
              <svg class="tool-icon" viewBox="0 0 32 32" width="32" height="32" aria-hidden="true" focusable="false"><circle cx="16" cy="16" r="10" fill="currentColor" /></svg>
              <span>塗り丸</span>
            </button>
            <button type="button" class="tool-button" data-tool="fill" data-tool-group="fill" aria-pressed="false">
              <img src="assets/icons/tool-fill.png" alt="塗りつぶし" width="32" height="32" />
              <span>塗りつぶし</span>
            </button>
            <button type="button" class="tool-button" data-tool="selectRect" data-tool-group="selection" aria-pressed="false">
              <img src="assets/icons/tool-select-rect.svg" alt="矩形選択" width="32" height="32" />
              <span>矩形選択</span>
            </button>
            <button type="button" class="tool-button" data-tool="selectLasso" data-tool-group="selection" aria-pressed="false">
              <img src="assets/icons/tool-select-lasso.svg" alt="投げ縄" width="32" height="32" />
              <span>投げ縄</span>
            </button>
            <button type="button" class="tool-button" data-tool="selectSame" data-tool-group="selection" aria-pressed="false">
              <img src="assets/icons/tool-select-magic.svg" alt="同色選択" width="32" height="32" />
              <span>同色</span>
            </button>
          </div>
          <div class="field-group">
            <label class="field">
              <span>ブラシサイズ</span>
              <input type="range" id="brushSize" min="1" max="12" value="1" />
              <output id="brushSizeValue" for="brushSize">1px</output>
            </label>
            <label class="field">
              <span>不透明度</span>
              <input type="range" id="brushOpacity" min="0" max="100" value="100" />
              <output id="brushOpacityValue" for="brushOpacity">100%</output>
            </label>
          </div>
        </div>
      </section>

      <section class="panel-section" id="panelColor" data-section="color">
        <div class="panel-section__body">
          <fieldset class="field field--inline" role="radiogroup" aria-label="カラーモード">
            <legend>モード</legend>
            <label><input type="radio" name="colorMode" value="index" checked />インデックス</label>
            <label><input type="radio" name="colorMode" value="rgb" />RGB</label>
          </fieldset>
          <div class="color-mode color-mode--index" id="colorModeIndex">
            <div class="palette-header">
              <span>パレット</span>
              <button type="button" class="chip" id="addPaletteColor">＋ 追加</button>
            </div>
            <div class="palette-grid" id="paletteList" role="listbox" aria-label="カラーパレット"></div>
            <div class="palette-editor" id="paletteEditor">
              <label class="field field--compact">
                <span>インデックス</span>
                <input type="number" id="paletteIndex" min="0" step="1" />
              </label>
              <div class="palette-hsv" id="paletteHsvControls">
                <div class="palette-wheel" id="paletteWheelWrapper">
                  <canvas id="paletteColorWheel" width="220" height="220" aria-label="色相環"></canvas>
                  <div class="palette-wheel__cursor" id="paletteWheelCursor"></div>
                </div>
                <div class="palette-sliders">
                  <div class="palette-preview" id="palettePreview" aria-hidden="true"></div>
                  <label class="field field--compact">
                    <span>色相</span>
                    <input type="range" id="paletteHue" min="0" max="360" value="0" />
                  </label>
                  <label class="field field--compact">
                    <span>彩度</span>
                    <input type="range" id="paletteSaturation" min="0" max="100" value="0" />
                  </label>
                  <label class="field field--compact">
                    <span>明度</span>
                    <input type="range" id="paletteValue" min="0" max="100" value="100" />
                  </label>
                  <label class="field field--compact palette-alpha-field">
                    <span>アルファ</span>
                    <input type="range" id="paletteAlphaSlider" min="0" max="255" value="255" />
                    <output id="paletteAlphaValue" for="paletteAlphaSlider">255</output>
                  </label>
                </div>
              </div>
            </div>
          </div>
          <div class="color-mode color-mode--rgb" id="colorModeRgb" hidden>
            <label class="field">
              <span>色</span>
              <input type="color" id="rgbColor" value="#58c4ff" />
            </label>
            <div class="palette-rgb-fields">
              <label class="field field--tiny">
                <span>R</span>
                <input type="number" id="rgbR" min="0" max="255" value="88" />
              </label>
              <label class="field field--tiny">
                <span>G</span>
                <input type="number" id="rgbG" min="0" max="255" value="196" />
              </label>
              <label class="field field--tiny">
                <span>B</span>
                <input type="number" id="rgbB" min="0" max="255" value="255" />
              </label>
              <label class="field field--tiny">
                <span>A</span>
                <input type="number" id="rgbA" min="0" max="255" value="255" />
              </label>
            </div>
          </div>
        </div>
      </section>

      <section class="panel-section" id="panelFrames" data-section="frames">
        <div class="panel-section__body">
          <div class="timeline-card" role="group" aria-label="レイヤーとフレームのタイムライン">
            <div class="timeline-toolbar">
              <div class="timeline-toolbar__group" role="group" aria-label="レイヤー操作">
                <button type="button" class="chip" id="addLayer" aria-label="レイヤーを追加">＋</button>
                <button type="button" class="chip" id="removeLayer" aria-label="レイヤーを削除">－</button>
                <span class="timeline-toolbar__label">レイヤー</span>
              </div>
              <div class="timeline-toolbar__group" role="group" aria-label="フレーム操作">
                <button type="button" class="chip" id="addFrame" aria-label="フレームを追加">＋</button>
                <button type="button" class="chip" id="removeFrame" aria-label="フレームを削除">－</button>
                <span class="timeline-toolbar__label">フレーム</span>
              </div>
            </div>
            <div class="timeline-matrix-wrapper">
              <div class="timeline-matrix" id="timelineMatrix" role="grid" aria-label="フレームとレイヤーの一覧"></div>
            </div>
            <div class="timeline-footer">
              <div class="timeline" role="group" aria-label="アニメーション制御">
                <button type="button" class="chip" id="playAnimation">▶</button>
                <label class="field field--tiny timeline-fps-control">
                  <span>fps</span>
                  <input type="number" id="animationFps" min="1" max="60" value="12" />
                </label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="panel-section" id="panelSettings" data-section="settings">
        <div class="panel-section__body">
          <label class="field">
            <span>キャンバスサイズ</span>
            <div class="field field--inline">
              <label class="field field--tiny">
                <span>横</span>
                <input type="number" id="canvasWidth" min="1" max="256" value="128" />
              </label>
              <label class="field field--tiny">
                <span>縦</span>
                <input type="number" id="canvasHeight" min="1" max="256" value="128" />
              </label>
            </div>
          </label>
          <label class="field">
            <span>ズーム</span>
            <input type="range" id="zoomSlider" min="1" max="40" value="8" />
          </label>
          <div class="field field--list" role="group" aria-label="表示設定">
            <ul class="toggle-list">
              <li>
                <label class="toggle-option" for="toggleGrid">
                  <input type="checkbox" id="toggleGrid" checked />
                  <span>グリッド</span>
                </label>
              </li>
              <li>
                <label class="toggle-option" for="toggleMajorGrid">
                  <input type="checkbox" id="toggleMajorGrid" />
                  <span>メジャー</span>
                </label>
              </li>
              <li>
                <label class="toggle-option" for="toggleChecker">
                  <input type="checkbox" id="toggleChecker" checked />
                  <span>16px グレーチェック</span>
                </label>
              </li>
              <li>
                <label class="toggle-option" for="togglePixelPreview">
                  <input type="checkbox" id="togglePixelPreview" checked />
                  <span>1px ガイド</span>
                </label>
              </li>
            </ul>
            <button type="button" class="chip" id="toggleBackgroundMode" aria-pressed="false">背景</button>
          </div>
          <button type="button" class="button" id="newProject">新規作成</button>
          <button type="button" class="button" id="openDocument">ファイルを開く</button>
          <button type="button" class="button" id="clearCanvas">キャンバスをクリア</button>
          <button type="button" class="button" id="enableAutosave">ローカルに自動保存</button>
          <p class="help-text" id="autosaveStatus" aria-live="polite"></p>
          <div class="field memory-control" role="status" aria-live="polite">
            <span id="memoryUsage">メモリ: 計測中…</span>
            <button type="button" class="chip" id="memoryClear">メモリ削除</button>
          </div>
        </div>
      </section>
    </div>

    <dialog class="modal" id="newProjectDialog" aria-labelledby="newProjectTitle">
      <form class="modal__form" id="newProjectForm" method="dialog">
        <header class="modal__header">
          <h2 class="modal__title" id="newProjectTitle">新規プロジェクト</h2>
        </header>
        <div class="modal__body">
          <label class="field">
            <span>ファイル名</span>
            <input type="text" id="newProjectName" required maxlength="120" />
          </label>
          <div class="field field--inline">
            <span>キャンバスサイズ</span>
            <label class="field field--tiny">
              <span>横</span>
              <input type="number" id="newProjectWidth" min="1" max="256" required />
            </label>
            <label class="field field--tiny">
              <span>縦</span>
              <input type="number" id="newProjectHeight" min="1" max="256" required />
            </label>
          </div>
        </div>
        <footer class="modal__footer">
          <button type="button" class="button button--ghost" id="cancelNewProject">キャンセル</button>
          <button type="submit" class="button button--primary" id="confirmNewProject">作成</button>
        </footer>
      </form>
    </dialog>

    <script src="assets/js/app.js" defer></script>
    <script src="assets/js/pwa.js" defer></script>
  </body>
</html>
